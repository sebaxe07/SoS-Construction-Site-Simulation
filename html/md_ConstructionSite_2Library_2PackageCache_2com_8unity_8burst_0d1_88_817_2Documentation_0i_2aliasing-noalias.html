<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: NoAlias attribute</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">NoAlias attribute</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md714"></a></p>
<p>Use the <a href="xref:Unity.Burst.NoAliasAttribute"><code>[NoAlias]</code></a> attribute to give <a class="el" href="namespaceBurst.html">Burst</a> additional information on the aliasing of pointers and structs.</p>
<p>In most use cases, you won't need to use the <code>[NoAlias]</code> attribute. You don't need to use it with <a href="https://docs.unity3d.com/ScriptReference/Unity.Collections.LowLevel.Unsafe.NativeContainerAttribute.html"><code>[NativeContainer]</code></a> attributed structs, or with fields in job structs. This is because the <a class="el" href="namespaceBurst.html">Burst</a> compiler infers the no-alias information.</p>
<p>The <code>[NoAlias]</code> attribute is exposed so that you can construct complex data structures where <a class="el" href="namespaceBurst.html">Burst</a> can't infer the aliasing. If you use the <code>[NoAlias]</code> attribute on a pointer that could alias with another, it might result in undefined behavior and make it hard to track down bugs.</p>
<p>You can use this attribute in the following ways:</p>
<ul>
<li>On a function parameter it signifies that the parameter doesn't alias with any other parameter to the function.</li>
<li>On a struct field it signifies that the field doesn't alias with any other <code>[NoAlias]</code> field of the struct.</li>
<li>On a struct it signifies that the address of the struct can't appear within the struct itself.</li>
<li>On a function return value it signifies that the returned pointer doesn't alias with any other pointer returned from the same function.</li>
</ul>
<h1><a class="anchor" id="autotoc_md715"></a>
NoAlias function parameter</h1>
<p>The following is an example of aliasing:</p>
<div class="fragment"><div class="line"><span class="preprocessor"> #</span></div>
<div class="line"><span class="keywordtype">int</span> Foo(ref <span class="keywordtype">int</span> a, ref <span class="keywordtype">int</span> b)</div>
<div class="line">{</div>
<div class="line">    b = 13;</div>
<div class="line">    a = 42;</div>
<div class="line">    <span class="keywordflow">return</span> b;</div>
<div class="line">}</div>
</div><!-- fragment --><p>For this, <a class="el" href="namespaceBurst.html">Burst</a> produces the following assembly:</p>
<div class="fragment"><div class="line"> 86asm</div>
<div class="line">mov     dword ptr [rdx], 13</div>
<div class="line">mov     dword ptr [rcx], 42</div>
<div class="line">mov     eax, dword ptr [rdx]</div>
<div class="line">ret</div>
</div><!-- fragment --><p>This means that <a class="el" href="namespaceBurst.html">Burst</a> does the following:</p>
<ul>
<li>Stores 13 into <code>b</code>.</li>
<li>Stores 42 into <code>a</code>.</li>
<li>Reloads the value from <code>b</code> to return it.</li>
</ul>
<p><a class="el" href="namespaceBurst.html">Burst</a> has to reload <code>b</code> because it doesn't know whether <code>a</code> and <code>b</code> are backed by the same memory or not.</p>
<p>Add the <code>[NoAlias]</code> attribute to the code to change this:</p>
<div class="fragment"><div class="line"><span class="preprocessor"> #</span></div>
<div class="line"><span class="keywordtype">int</span> Foo([NoAlias] ref <span class="keywordtype">int</span> a, ref <span class="keywordtype">int</span> b)</div>
<div class="line">{</div>
<div class="line">    b = 13;</div>
<div class="line">    a = 42;</div>
<div class="line">    <span class="keywordflow">return</span> b;</div>
<div class="line">}</div>
</div><!-- fragment --><p>For this, <a class="el" href="namespaceBurst.html">Burst</a> produces the following assembly:</p>
<div class="fragment"><div class="line"> 86asm</div>
<div class="line">mov     dword ptr [rdx], 13</div>
<div class="line">mov     dword ptr [rcx], 42</div>
<div class="line">mov     eax, 13</div>
<div class="line">ret</div>
</div><!-- fragment --><p>In this case, the load from <code>b</code> has been replaced with moving the constant 13 into the return register.</p>
<h1><a class="anchor" id="autotoc_md716"></a>
NoAlias struct field</h1>
<p>The following example is the same as the previous, but applied to a struct:</p>
<div class="fragment"><div class="line"><span class="preprocessor"> #</span></div>
<div class="line"><span class="keyword">struct </span>Bar</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span> NativeArray&lt;int&gt; a;</div>
<div class="line">    <span class="keyword">public</span> NativeArray&lt;float&gt; b;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> Foo(ref Bar bar)</div>
<div class="line">{</div>
<div class="line">    bar.b[0] = 42.0f;</div>
<div class="line">    bar.a[0] = 13;</div>
<div class="line">    <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)bar.b[0];</div>
<div class="line">}</div>
</div><!-- fragment --><p>For this, <a class="el" href="namespaceBurst.html">Burst</a> produces the following assembly:</p>
<div class="fragment"><div class="line"> 86asm</div>
<div class="line">mov     rax, qword ptr [rcx + 16]</div>
<div class="line">mov     dword ptr [rax], 1109917696</div>
<div class="line">mov     rcx, qword ptr [rcx]</div>
<div class="line">mov     dword ptr [rcx], 13</div>
<div class="line">cvttss2si       eax, dword ptr [rax]</div>
<div class="line">ret</div>
</div><!-- fragment --><p>In this case, <a class="el" href="namespaceBurst.html">Burst</a> does the following:</p>
<ul>
<li>Loads the address of the data in <code>b</code> into <code>rax</code>.</li>
<li>Stores 42 into it (<code>1109917696</code> is <code>0x42280000</code>, which is <code>42.0f</code>).</li>
<li>Loads the address of the data in <code>a</code> into <code>rcx</code>.</li>
<li>Stores 13 into it.</li>
<li>Reloads the data in <code>b</code> and converts it to an integer for returning.</li>
</ul>
<p>If you know that the two <code>NativeArrays</code> aren't backed by the same memory, you can change the code to the following:</p>
<div class="fragment"><div class="line"><span class="preprocessor"> #</span></div>
<div class="line"><span class="keyword">struct </span>Bar</div>
<div class="line">{</div>
<div class="line">    [NoAlias]</div>
<div class="line">    <span class="keyword">public</span> NativeArray&lt;int&gt; a;</div>
<div class="line"> </div>
<div class="line">    [NoAlias]</div>
<div class="line">    <span class="keyword">public</span> NativeArray&lt;float&gt; b;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> Foo(ref Bar bar)</div>
<div class="line">{</div>
<div class="line">    bar.b[0] = 42.0f;</div>
<div class="line">    bar.a[0] = 13;</div>
<div class="line">    <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)bar.b[0];</div>
<div class="line">}</div>
</div><!-- fragment --><p>If you attribute both <code>a</code> and <code>b</code> with <code>[NoAlias]</code> it tells <a class="el" href="namespaceBurst.html">Burst</a> that they don't alias with each other within the struct, which produces the following assembly:</p>
<div class="fragment"><div class="line"> 86asm</div>
<div class="line">mov     rax, qword ptr [rcx + 16]</div>
<div class="line">mov     dword ptr [rax], 1109917696</div>
<div class="line">mov     rax, qword ptr [rcx]</div>
<div class="line">mov     dword ptr [rax], 13</div>
<div class="line">mov     eax, 42</div>
<div class="line">ret</div>
</div><!-- fragment --><p>This means that <a class="el" href="namespaceBurst.html">Burst</a> can return the integer constant 42.</p>
<h1><a class="anchor" id="autotoc_md717"></a>
NoAlias struct</h1>
<p><a class="el" href="namespaceBurst.html">Burst</a> assumes that the pointer to a struct doesn't appear within the struct itself. However, there are cases where this isn't true:</p>
<div class="fragment"><div class="line"><span class="preprocessor"> #</span></div>
<div class="line">unsafe <span class="keyword">struct </span>CircularList</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span> CircularList* next;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">public</span> CircularList()</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// The &#39;empty&#39; list just points to itself.</span></div>
<div class="line">        next = <span class="keyword">this</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Lists are one of the few structures where it's normal to have the pointer to the struct accessible from somewhere within the struct itself.</p>
<p>The following example indicates where <code>[NoAlias]</code> on a struct can help:</p>
<div class="fragment"><div class="line"><span class="preprocessor"> #</span></div>
<div class="line">unsafe <span class="keyword">struct </span>Bar</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">int</span> i;</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span>* p;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">float</span> Foo(ref Bar bar)</div>
<div class="line">{</div>
<div class="line">    *(<span class="keywordtype">int</span>*)bar.p = 42;</div>
<div class="line">    <span class="keywordflow">return</span> ((<span class="keywordtype">float</span>*)bar.p)[bar.i];</div>
<div class="line">}</div>
</div><!-- fragment --><p>This produces the following assembly:</p>
<div class="fragment"><div class="line"> 86asm</div>
<div class="line">mov     rax, qword ptr [rcx + 8]</div>
<div class="line">mov     dword ptr [rax], 42</div>
<div class="line">mov     rax, qword ptr [rcx + 8]</div>
<div class="line">mov     ecx, dword ptr [rcx]</div>
<div class="line">movss   xmm0, dword ptr [rax + 4*rcx]</div>
<div class="line">ret</div>
</div><!-- fragment --><p>In this case, <a class="el" href="namespaceBurst.html">Burst</a>:</p><ul>
<li>Loads <code>p</code> into <code>rax</code>.</li>
<li>Stores 42 into <code>p</code>.</li>
<li>Loads <code>p</code> into <code>rax</code> again.</li>
<li>Loads <code>i</code> into <code>ecx</code>.</li>
<li>Returns the index into <code>p</code> by <code>i</code>.</li>
</ul>
<p>In this situation, <a class="el" href="namespaceBurst.html">Burst</a> loads <code>p</code> twice. This is because it doesn't know if <code>p</code> points to the address of the struct <code>bar</code>. Once it stores 42 into <code>p</code> it has to reload the address of <code>p</code> from <code>bar</code>, which is a costly operation.</p>
<p>Add <code>[NoAlias]</code> to prevent this:</p>
<div class="fragment"><div class="line"><span class="preprocessor"> #</span></div>
<div class="line">[NoAlias]</div>
<div class="line">unsafe <span class="keyword">struct </span>Bar</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">int</span> i;</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span>* p;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">float</span> Foo(ref Bar bar)</div>
<div class="line">{</div>
<div class="line">    *(<span class="keywordtype">int</span>*)bar.p = 42;</div>
<div class="line">    <span class="keywordflow">return</span> ((<span class="keywordtype">float</span>*)bar.p)[bar.i];</div>
<div class="line">}</div>
</div><!-- fragment --><p>This produces the following assembly:</p>
<div class="fragment"><div class="line"> 86asm</div>
<div class="line">mov     rax, qword ptr [rcx + 8]</div>
<div class="line">mov     dword ptr [rax], 42</div>
<div class="line">mov     ecx, dword ptr [rcx]</div>
<div class="line">movss   xmm0, dword ptr [rax + 4*rcx]</div>
<div class="line">ret</div>
</div><!-- fragment --><p>In this situation, <a class="el" href="namespaceBurst.html">Burst</a> only loads the address of <code>p</code> once, because <code>[NoAlias]</code> tells it that <code>p</code> can't be the pointer to <code>bar</code>.</p>
<h1><a class="anchor" id="autotoc_md718"></a>
NoAlias function return</h1>
<p>Some functions can only return a unique pointer. For instance, <code>malloc</code> only returns a unique pointer. In this case, <code>[return:NoAlias]</code> gives some useful information to <a class="el" href="namespaceBurst.html">Burst</a>.</p>
<p>&gt;[!IMPORTANT] &gt;Only use <code>[return: NoAlias]</code> on functions that are guaranteed to produce a unique pointer. For example, with bump-allocations, or with things like <code>malloc</code>. <a class="el" href="namespaceBurst.html">Burst</a> aggressively inlines functions for performance considerations, so with small functions, <a class="el" href="namespaceBurst.html">Burst</a> inlines them into their parents to produce the same result without the attribute.</p>
<p>The following example uses a bump allocator backed with a stack allocation:</p>
<div class="fragment"><div class="line"><span class="preprocessor"> #</span></div>
<div class="line"><span class="comment">// Only ever returns a unique address into the stackalloc&#39;ed memory.</span></div>
<div class="line"><span class="comment">// We&#39;ve made this no-inline because Burst will always try and inline</span></div>
<div class="line"><span class="comment">// small functions like these, which would defeat the purpose of this</span></div>
<div class="line"><span class="comment">// example</span></div>
<div class="line">[MethodImpl(MethodImplOptions.NoInlining)]</div>
<div class="line">unsafe <span class="keywordtype">int</span>* BumpAlloc(<span class="keywordtype">int</span>* alloca)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> location = alloca[0]++;</div>
<div class="line">    <span class="keywordflow">return</span> alloca + location;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">unsafe <span class="keywordtype">int</span> Func()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span>* alloca = stackalloc <span class="keywordtype">int</span>[128];</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Store our size at the start of the alloca.</span></div>
<div class="line">    alloca[0] = 1;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span>* ptr1 = BumpAlloc(alloca);</div>
<div class="line">    <span class="keywordtype">int</span>* ptr2 = BumpAlloc(alloca);</div>
<div class="line"> </div>
<div class="line">    *ptr1 = 42;</div>
<div class="line">    *ptr2 = 13;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> *ptr1;</div>
<div class="line">}</div>
</div><!-- fragment --><p>This produces the following assembly:</p>
<div class="fragment"><div class="line"> 86asm</div>
<div class="line">push    rsi</div>
<div class="line">push    rdi</div>
<div class="line">push    rbx</div>
<div class="line">sub     rsp, 544</div>
<div class="line">lea     rcx, [rsp + 36]</div>
<div class="line">movabs  rax, offset memset</div>
<div class="line">mov     r8d, 508</div>
<div class="line">xor     edx, edx</div>
<div class="line">call    rax</div>
<div class="line">mov     dword ptr [rsp + 32], 1</div>
<div class="line">movabs  rbx, offset &quot;BumpAlloc(int* alloca)&quot;</div>
<div class="line">lea     rsi, [rsp + 32]</div>
<div class="line">mov     rcx, rsi</div>
<div class="line">call    rbx</div>
<div class="line">mov     rdi, rax</div>
<div class="line">mov     rcx, rsi</div>
<div class="line">call    rbx</div>
<div class="line">mov     dword ptr [rdi], 42</div>
<div class="line">mov     dword ptr [rax], 13</div>
<div class="line">mov     eax, dword ptr [rdi]</div>
<div class="line">add     rsp, 544</div>
<div class="line">pop     rbx</div>
<div class="line">pop     rdi</div>
<div class="line">pop     rsi</div>
<div class="line">ret</div>
</div><!-- fragment --><p>The key things that <a class="el" href="namespaceBurst.html">Burst</a> does:</p>
<ul>
<li>Has <code>ptr1</code> in <code>rdi</code>.</li>
<li>Has <code>ptr2</code> in <code>rax</code>.</li>
<li>Stores 42 into <code>ptr1</code>.</li>
<li>Stores 13 into <code>ptr2</code>.</li>
<li>Loads <code>ptr1</code> again to return it.</li>
</ul>
<p>If you add the <code>[return: NoAlias]</code> attribute:</p>
<div class="fragment"><div class="line"><span class="preprocessor"> #</span></div>
<div class="line">[MethodImpl(MethodImplOptions.NoInlining)]</div>
<div class="line">[<span class="keywordflow">return</span>: NoAlias]</div>
<div class="line">unsafe <span class="keywordtype">int</span>* BumpAlloc(<span class="keywordtype">int</span>* alloca)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> location = alloca[0]++;</div>
<div class="line">    <span class="keywordflow">return</span> alloca + location;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">unsafe <span class="keywordtype">int</span> Func()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span>* alloca = stackalloc <span class="keywordtype">int</span>[128];</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Store our size at the start of the alloca.</span></div>
<div class="line">    alloca[0] = 1;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span>* ptr1 = BumpAlloc(alloca);</div>
<div class="line">    <span class="keywordtype">int</span>* ptr2 = BumpAlloc(alloca);</div>
<div class="line"> </div>
<div class="line">    *ptr1 = 42;</div>
<div class="line">    *ptr2 = 13;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> *ptr1;</div>
<div class="line">}</div>
</div><!-- fragment --><p>It produces the following assembly:</p>
<div class="fragment"><div class="line"> 86asm</div>
<div class="line">push    rsi</div>
<div class="line">push    rdi</div>
<div class="line">push    rbx</div>
<div class="line">sub     rsp, 544</div>
<div class="line">lea     rcx, [rsp + 36]</div>
<div class="line">movabs  rax, offset memset</div>
<div class="line">mov     r8d, 508</div>
<div class="line">xor     edx, edx</div>
<div class="line">call    rax</div>
<div class="line">mov     dword ptr [rsp + 32], 1</div>
<div class="line">movabs  rbx, offset &quot;BumpAlloc(int* alloca)&quot;</div>
<div class="line">lea     rsi, [rsp + 32]</div>
<div class="line">mov     rcx, rsi</div>
<div class="line">call    rbx</div>
<div class="line">mov     rdi, rax</div>
<div class="line">mov     rcx, rsi</div>
<div class="line">call    rbx</div>
<div class="line">mov     dword ptr [rdi], 42</div>
<div class="line">mov     dword ptr [rax], 13</div>
<div class="line">mov     eax, 42</div>
<div class="line">add     rsp, 544</div>
<div class="line">pop     rbx</div>
<div class="line">pop     rdi</div>
<div class="line">pop     rsi</div>
<div class="line">ret</div>
</div><!-- fragment --><p>In this case, <a class="el" href="namespaceBurst.html">Burst</a> doesn't reload <code>ptr2</code>, and moves 42 into the return register. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
