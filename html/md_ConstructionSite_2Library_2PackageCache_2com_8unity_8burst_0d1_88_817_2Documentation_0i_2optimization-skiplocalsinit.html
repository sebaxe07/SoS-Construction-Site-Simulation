<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: SkipLocalsInit attribute</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">SkipLocalsInit attribute</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md866"></a></p>
<p>Use <a href="xref:Unity.Burst.CompilerServices.SkipLocalsInitAttribute"><code>SkipLocalsInitAttribute</code></a>, to tell <a class="el" href="namespaceBurst.html">Burst</a> that any stack allocations within a method don't have to be initialized to zero.</p>
<p>In C# all local variables are initialized to zero by default. This is useful because it means an entire class of bugs surrounding undefined data disappears. But this can impact runtime performance, because initializing this data to zero takes work:</p>
<div class="fragment"><div class="line"><span class="preprocessor"> #</span></div>
<div class="line"><span class="keyword">static</span> unsafe <span class="keywordtype">int</span> DoSomethingWithLUT(<span class="keywordtype">int</span>* data);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> unsafe <span class="keywordtype">int</span> DoSomething(<span class="keywordtype">int</span> size)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span>* data = stackalloc <span class="keywordtype">int</span>[size];</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Initialize every field of data to be an incrementing set of values.</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; size; i++)</div>
<div class="line">    {</div>
<div class="line">        data[i] = i;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Use the data elsewhere.</span></div>
<div class="line">    <span class="keywordflow">return</span> DoSomethingWithLUT(data);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The X86 assembly for this is:</p>
<div class="fragment"><div class="line"> 86asm</div>
<div class="line">        push    rbp</div>
<div class="line">        .seh_pushreg rbp</div>
<div class="line">        push    rsi</div>
<div class="line">        .seh_pushreg rsi</div>
<div class="line">        push    rdi</div>
<div class="line">        .seh_pushreg rdi</div>
<div class="line">        mov     rbp, rsp</div>
<div class="line">        .seh_setframe rbp, 0</div>
<div class="line">        .seh_endprologue</div>
<div class="line">        mov     edi, ecx</div>
<div class="line">        lea     r8d, [4*rdi]</div>
<div class="line">        lea     rax, [r8 + 15]</div>
<div class="line">        and     rax, -16</div>
<div class="line">        movabs  r11, offset __chkstk</div>
<div class="line">        call    r11</div>
<div class="line">        sub     rsp, rax</div>
<div class="line">        mov     rsi, rsp</div>
<div class="line">        sub     rsp, 32</div>
<div class="line">        movabs  rax, offset burst.memset.inline.X64_SSE4.i32@@32</div>
<div class="line">        mov     rcx, rsi</div>
<div class="line">        xor     edx, edx</div>
<div class="line">        xor     r9d, r9d</div>
<div class="line">        call    rax</div>
<div class="line">        add     rsp, 32</div>
<div class="line">        test    edi, edi</div>
<div class="line">        jle     .LBB0_7</div>
<div class="line">        mov     eax, edi</div>
<div class="line">        cmp     edi, 8</div>
<div class="line">        jae     .LBB0_3</div>
<div class="line">        xor     ecx, ecx</div>
<div class="line">        jmp     .LBB0_6</div>
<div class="line">.LBB0_3:</div>
<div class="line">        mov     ecx, eax</div>
<div class="line">        and     ecx, -8</div>
<div class="line">        movabs  rdx, offset __xmm@00000003000000020000000100000000</div>
<div class="line">        movdqa  xmm0, xmmword ptr [rdx]</div>
<div class="line">        mov     rdx, rsi</div>
<div class="line">        add     rdx, 16</div>
<div class="line">        movabs  rdi, offset __xmm@00000004000000040000000400000004</div>
<div class="line">        movdqa  xmm1, xmmword ptr [rdi]</div>
<div class="line">        movabs  rdi, offset __xmm@00000008000000080000000800000008</div>
<div class="line">        movdqa  xmm2, xmmword ptr [rdi]</div>
<div class="line">        mov     rdi, rcx</div>
<div class="line">        .p2align        4, 0x90</div>
<div class="line">.LBB0_4:</div>
<div class="line">        movdqa  xmm3, xmm0</div>
<div class="line">        paddd   xmm3, xmm1</div>
<div class="line">        movdqu  xmmword ptr [rdx - 16], xmm0</div>
<div class="line">        movdqu  xmmword ptr [rdx], xmm3</div>
<div class="line">        paddd   xmm0, xmm2</div>
<div class="line">        add     rdx, 32</div>
<div class="line">        add     rdi, -8</div>
<div class="line">        jne     .LBB0_4</div>
<div class="line">        cmp     rcx, rax</div>
<div class="line">        je      .LBB0_7</div>
<div class="line">        .p2align        4, 0x90</div>
<div class="line">.LBB0_6:</div>
<div class="line">        mov     dword ptr [rsi + 4*rcx], ecx</div>
<div class="line">        inc     rcx</div>
<div class="line">        cmp     rax, rcx</div>
<div class="line">        jne     .LBB0_6</div>
<div class="line">.LBB0_7:</div>
<div class="line">        sub     rsp, 32</div>
<div class="line">        movabs  rax, offset &quot;DoSomethingWithLUT&quot;</div>
<div class="line">        mov     rcx, rsi</div>
<div class="line">        call    rax</div>
<div class="line">        nop</div>
<div class="line">        mov     rsp, rbp</div>
<div class="line">        pop     rdi</div>
<div class="line">        pop     rsi</div>
<div class="line">        pop     rbp</div>
<div class="line">        ret</div>
</div><!-- fragment --><p>In this example, the <code>movabs rax, offset burst.memset.inline.X64_SSE4.i32@@32</code> line means that you've had to inject a memset to zero out the data. In the above example, you know that the array is entirely initialized in the following loop, but <a class="el" href="namespaceBurst.html">Burst</a> doesn't know that.</p>
<p>To fix this problem, use <a href="xref:Unity.Burst.CompilerServices.SkipLocalsInitAttribute"><code>Unity.Burst.CompilerServices.SkipLocalsInitAttribute</code></a>, which tells <a class="el" href="namespaceBurst.html">Burst</a> that any stack allocations within a method don't have to be initialized to zero.</p>
<p>&gt;[!NOTE] &gt;Only use this attribute if you're certain that you won't run into undefined behavior bugs.</p>
<p>For example:</p>
<div class="fragment"><div class="line"><span class="preprocessor"> #</span></div>
<div class="line"><span class="keyword">using </span>Unity.Burst.CompilerServices;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> unsafe <span class="keywordtype">int</span> DoSomethingWithLUT(<span class="keywordtype">int</span>* data);</div>
<div class="line"> </div>
<div class="line">[SkipLocalsInit]</div>
<div class="line"><span class="keyword">static</span> unsafe <span class="keywordtype">int</span> DoSomething(<span class="keywordtype">int</span> size)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span>* data = stackalloc <span class="keywordtype">int</span>[size];</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Initialize every field of data to be an incrementing set of values.</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; size; i++)</div>
<div class="line">    {</div>
<div class="line">        data[i] = i;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Use the data elsewhere.</span></div>
<div class="line">    <span class="keywordflow">return</span> DoSomethingWithLUT(data);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The assembly after adding the <code>[SkipLocalsInit]</code> on the method is:</p>
<div class="fragment"><div class="line"> 86asm</div>
<div class="line">        push    rbp</div>
<div class="line">        .seh_pushreg rbp</div>
<div class="line">        mov     rbp, rsp</div>
<div class="line">        .seh_setframe rbp, 0</div>
<div class="line">        .seh_endprologue</div>
<div class="line">        mov     edx, ecx</div>
<div class="line">        lea     eax, [4*rdx]</div>
<div class="line">        add     rax, 15</div>
<div class="line">        and     rax, -16</div>
<div class="line">        movabs  r11, offset __chkstk</div>
<div class="line">        call    r11</div>
<div class="line">        sub     rsp, rax</div>
<div class="line">        mov     rcx, rsp</div>
<div class="line">        test    edx, edx</div>
<div class="line">        jle     .LBB0_7</div>
<div class="line">        mov     r8d, edx</div>
<div class="line">        cmp     edx, 8</div>
<div class="line">        jae     .LBB0_3</div>
<div class="line">        xor     r10d, r10d</div>
<div class="line">        jmp     .LBB0_6</div>
<div class="line">.LBB0_3:</div>
<div class="line">        mov     r10d, r8d</div>
<div class="line">        and     r10d, -8</div>
<div class="line">        movabs  rax, offset __xmm@00000003000000020000000100000000</div>
<div class="line">        movdqa  xmm0, xmmword ptr [rax]</div>
<div class="line">        mov     rax, rcx</div>
<div class="line">        add     rax, 16</div>
<div class="line">        movabs  rdx, offset __xmm@00000004000000040000000400000004</div>
<div class="line">        movdqa  xmm1, xmmword ptr [rdx]</div>
<div class="line">        movabs  rdx, offset __xmm@00000008000000080000000800000008</div>
<div class="line">        movdqa  xmm2, xmmword ptr [rdx]</div>
<div class="line">        mov     r9, r10</div>
<div class="line">        .p2align        4, 0x90</div>
<div class="line">.LBB0_4:</div>
<div class="line">        movdqa  xmm3, xmm0</div>
<div class="line">        paddd   xmm3, xmm1</div>
<div class="line">        movdqu  xmmword ptr [rax - 16], xmm0</div>
<div class="line">        movdqu  xmmword ptr [rax], xmm3</div>
<div class="line">        paddd   xmm0, xmm2</div>
<div class="line">        add     rax, 32</div>
<div class="line">        add     r9, -8</div>
<div class="line">        jne     .LBB0_4</div>
<div class="line">        cmp     r10, r8</div>
<div class="line">        je      .LBB0_7</div>
<div class="line">        .p2align        4, 0x90</div>
<div class="line">.LBB0_6:</div>
<div class="line">        mov     dword ptr [rcx + 4*r10], r10d</div>
<div class="line">        inc     r10</div>
<div class="line">        cmp     r8, r10</div>
<div class="line">        jne     .LBB0_6</div>
<div class="line">.LBB0_7:</div>
<div class="line">        sub     rsp, 32</div>
<div class="line">        movabs  rax, offset &quot;DoSomethingWithLUT&quot;</div>
<div class="line">        call    rax</div>
<div class="line">        nop</div>
<div class="line">        mov     rsp, rbp</div>
<div class="line">        pop     rbp</div>
<div class="line">        ret</div>
</div><!-- fragment --><p>The call to memset is now gone, because you've told <a class="el" href="namespaceBurst.html">Burst</a> that any stack allocations within a method don't have to be initialized to zero. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
